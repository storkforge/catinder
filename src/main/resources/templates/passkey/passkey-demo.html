<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catinder – Passkey Demo</title>
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="form-container">
    <h2>Register a Passkey</h2>
    <button onclick="registerPasskey()" class="submit">Create Passkey</button>
    <p id="statusMessage" style="margin-top: 1em;"></p>
</div>

<script>
    // Check if WebAuthn is supported by this browser
    if (!window.PublicKeyCredential) {
        document.getElementById("statusMessage").innerHTML =
            "<strong>WebAuthn is not supported by this browser.</strong><br>" +
            "Please use a modern browser like Chrome, Firefox, Safari, or Edge.";
        document.querySelector("button").disabled = true;
    }

    async function registerPasskey() {
        const optionsResponse = await fetch("/passkey/begin-registration", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({username: "demo@catinder.com"})
        });

        if (!optionsResponse.ok) {
            throw new Error("Failed to get registration options: " + await optionsResponse.text());
        }

        const publicKeyOptions = await optionsResponse.json();

        // Convert base64 strings from server to ArrayBuffers
        publicKeyOptions.challenge = base64ToArrayBuffer(publicKeyOptions.challenge);
        publicKeyOptions.user.id = base64ToArrayBuffer(publicKeyOptions.user.id);

        try {
            const credential = await navigator.credentials.create({publicKey: publicKeyOptions});
            const json = JSON.stringify(credential, replacer);

            const res = await fetch("/passkey/register", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: json
            });

            document.getElementById("statusMessage").innerText = await res.text();

        } catch (e) {
            console.error(e);
            document.getElementById("statusMessage").innerText = "❌ Error: " + e.message;
        }
    }

    // Replace binary with base64 for transport
    function replacer(key, value) {
        if (value instanceof ArrayBuffer) {
            return btoa(String.fromCharCode(...new Uint8Array(value)));
        }
        return value;
    }
</script>

</body>
</html>
