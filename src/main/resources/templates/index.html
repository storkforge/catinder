<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/springsecurity6"
      th:lang="en">
<head>
    <meta charset="UTF-8">
    <title>Catinder - Home</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
</head>
<body>
<div th:replace="fragments/header"></div>

<div id="successMessage" class="success-message" th:if="${delete_success}" th:text="#{UserDeleteSuccessTranslated}"></div>

<!--TO ADMIN DASHBOARD-->
<a sec:authorize="hasRole('ADMIN')"
   th:href="@{/admin/dashboard}"
   class="nav-button admin-button">
    <img class="header-choice" src="/images/security.png" alt="Admin"/>
    <span>Admin Dashboard</span>
</a>
<!--HANDLE CATS BUTTON-->
<div sec:authorize="isAuthenticated()" class="header-nav">
    <a class="submit create-button" th:href="@{/cats}">
        <span th:text="#{handle.your.cats}">Handle cats</span>
    </a>
</div>


<div sec:authorize="isAuthenticated()" class="slideshow-container catPhotos-container">
    <div class="mySlides fade" th:each="photo : ${catPhotos}">
        <div class="image‐wrapper">
            <img th:src="@{${photo.catPhotoUrl}}"
                 th:alt="${photo.catPhotoCaption} ?: 'Cat photo'"/>
        </div>
        <div class="cat-details">
            <p style="font-size: 22px"><strong> <span
                    th:text="${photo.catPhotoCat.catName} + ', ' + ${photo.catPhotoCat.catAge}"></span></strong></p>
            <p><strong th:text="#{cat.breed} + ': '">Breed:</strong> <span
                    th:text="${photo.catPhotoCat.catBreed}"></span></p>
            <p><strong th:text="#{cat.gender} + ': '">Gender:</strong> <span
                    th:text="${photo.catPhotoCat.catGender}"></span></p>
            <p><strong th:text="#{cat.personality} + ': '">Personality:</strong> <span
                    th:text="${photo.catPhotoCat.catPersonality}"></span></p>
        </div>
    </div>
    <a class="prev" onclick="plusSlides(-1)">❮</a>
    <a class="next" onclick="plusSlides(1)">❯</a>
</div>
<div sec:authorize="!isAuthenticated()" style="margin-top: 8%">
    <h2>Welcome!</h2>
    <p>Please click the login-button to sign in/create an account!</p>
</div>

<!-- Eva testar passkey grej -->
<div class="login-test-buttons" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
    <button class="login-button google-login" onclick="location.href='/oauth2/authorization/google'">
        Login with Google
    </button>

    <button id="passkey-login-btn" class="login-button passkey-login">
        Login with Passkey
    </button>
</div>

<script>
    document.getElementById("passkey-login-btn").addEventListener("click", async () => {
        const email = prompt("What's your email?");
        if (!email) return;

        try {
            const startResp = await fetch(`/passkey/webauthn/login/start?userEmail=${encodeURIComponent(email)}`);
            const options = await startResp.json();

            // Konvertera Base64 → ArrayBuffer
            options.publicKey.challenge = base64urlToBuffer(options.publicKey.challenge);
            options.publicKey.allowCredentials = options.publicKey.allowCredentials.map(cred => ({
                ...cred,
                id: base64urlToBuffer(cred.id)
            }));

            const credential = await navigator.credentials.get({
                publicKey: options.publicKey
            });

            const authData = {
                id: credential.id,
                rawId: bufferToBase64url(credential.rawId),
                type: credential.type,
                response: {
                    authenticatorData: bufferToBase64url(credential.response.authenticatorData),
                    clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                    signature: bufferToBase64url(credential.response.signature),
                    userHandle: credential.response.userHandle
                        ? bufferToBase64url(credential.response.userHandle)
                        : null
                }
            };

            const finishResp = await fetch("/passkey/webauthn/login/finish", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(authData)
            });

            if (finishResp.ok) {
                window.location.href = "/dashboard";
            } else {
                alert("Login failed");
            }
        } catch (err) {
            console.error("Passkey login error:", err);
            alert("An error occurred during login.");
        }
    });

    function base64urlToBuffer(base64url) {
        const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/");
        const pad = "=".repeat((4 - base64url.length % 4) % 4);
        const binary = atob(base64 + pad);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function bufferToBase64url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }
</script>
<!-- Slut på Eva testar passkey grej -->

<script>
    setTimeout(function () {
        var successMsg = document.getElementById('successMessage');
        if (successMsg) {
            successMsg.style.display = 'none';
        }
    }, 5000);
    let slideIndex = 1;
    showSlides(slideIndex);

    function plusSlides(n) {
        showSlides(slideIndex += n);
    }

    function currentSlide(n) {
        showSlides(slideIndex = n);
    }

    function showSlides(n) {
        let i;
        let slides = document.getElementsByClassName("mySlides");
        let dots = document.getElementsByClassName("dot");
        if (n > slides.length) {
            slideIndex = 1
        }
        if (n < 1) {
            slideIndex = slides.length
        }
        for (i = 0; i < slides.length; i++) {
            slides[i].style.display = "none";
        }
        for (i = 0; i < dots.length; i++) {
            dots[i].className = dots[i].className.replace(" active", "");
        }
        slides[slideIndex - 1].style.display = "block";
        dots[slideIndex - 1].className += " active";
    }
</script>
</body>
</html>
